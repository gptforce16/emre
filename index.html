<!DOCTYPE html>  
<html lang="tr">  
<head>  
  <meta charset="UTF-8">  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">  
  <title>Su Tesisleri Dairesi Başkanlığı Piezometre Hesaplama Tablosu</title>  
  <style>  
    html, body {  
      touch-action: none;  
    }  
    body {  
      font-family: sans-serif;  
      padding: 1rem;  
      max-width: 800px;  
      margin: auto;  
    }  
    h2 {
      text-align: center;
      color: #8B0000;
      margin-bottom: 1rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 1rem;
      table-layout: fixed;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: center;
      word-wrap: break-word;
      white-space: normal;
      overflow-wrap: break-word;
    }
    th {
      background-color: #f4f4f4;
      font-size: 12px;
    }
    input, select {
      width: 100%;
      padding: 6px;
      margin: 5px 0;
      box-sizing: border-box;
      border-radius: 5px;
      border: 1px solid #ddd;
      font-size: 11px;
    }
    button {
      padding: 8px 12px;
      margin-top: 10px;
      border-radius: 5px;
      background-color: #008CBA;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background-color: #006F8E;
    }
    select.boru,
    select.atu {
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      background-image: none;
      width: 100%;
      max-width: 250px;
      padding: 6px;
      margin: 5px 0;
      box-sizing: border-box;
      border-radius: 5px;
      border: 1px solid #ddd;
      font-size: 12px;
    }
    .output {
      background: #f9f9f9;
      font-weight: bold;
    }
    .hidden {
      display: none;
    }
    th, td {  
      width: 16%;  
    }  
    @media (max-width: 768px) {  
      table {  
        display: block;  
        overflow-x: auto;  
        white-space: nowrap;  
      }  
    }
  </style>  
</head>  
<body>  
  <h2>Su Tesisleri Dairesi Başkanlığı Piezometre Hesaplama Tablosu</h2>  
  <table>  
    <thead>  
      <tr>  
        <th>Debi (L/s)</th>  
        <th>Kot (m)</th>  
        <th>Mesafe (m)</th>  
        <th>Boru Çapı (mm)</th>  
        <th>Atü (bar)</th>  
        <th>İşletme Basıncı</th>  
      </tr>  
    </thead>  
    <tbody id="noktalarTablo">  
    </tbody>  
  </table>  

  <button onclick="ekleNokta()">Nokta Ekle</button>
  <button onclick="hesapla()">Hesapla</button>
  <button onclick="exceleKaydet()">Excel'e Kaydet</button>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <script>  
    const boruTablosu = {
      "110": { "10": 96.8, "16": 90 },
      "125": { "10": 110.2, "16": 102.2 },
      "140": { "10": 123.4, "16": 114.6 },
      "160": { "10": 141, "16": 130.8 },
      "180": { "10": 158.6, "16": 147.2 },
      "200": { "10": 176.2, "16": 163.6 },
      "225": { "10": 198.2, "16": 184 },
      "250": { "10": 220.4, "16": 204.6 },
      "280": { "10": 246.8, "16": 229.2 },
      "315": { "10": 277.6, "16": 257.8 },
      "355": { "10": 312.8, "16": 290.6 },
      "400": { "10": 352.6, "16": 327.4 },
      "450": { "10": 396.6, "16": 368.2 }
    };

    function ekleNokta() {  
      const tbody = document.getElementById('noktalarTablo');  
      const row = document.createElement('tr');  
      const boruOnceki = tbody.children.length > 0 ? tbody.children[tbody.children.length - 1].querySelector('.boru').value : '110';  
      const atuOnceki = tbody.children.length > 0 ? tbody.children[tbody.children.length - 1].querySelector('.atu').value : '10';  
      const debiOnceki = tbody.children.length > 0 ? tbody.children[tbody.children.length - 1].querySelector('.debi').value : '';  
  
      row.innerHTML = `  
        <td><input type="number" class="debi" value="${debiOnceki}" placeholder="debi" /></td>  
        <td><input type="number" class="kot" placeholder="kot" /></td>  
        <td><input type="number" class="mesafe" placeholder="mesafe" value="${tbody.children.length === 0 ? 0 : ''}" ${tbody.children.length === 0 ? 'readonly' : ''} /></td>  
        <td><select class="boru">  
          ${Object.keys(boruTablosu).map(c => `<option value="${c}" ${boruOnceki === c ? 'selected' : ''}>${c}</option>`).join('')}  
        </select></td>  
        <td><select class="atu">  
          <option value="10" ${atuOnceki === '10' ? 'selected' : ''}>10</option>  
          <option value="16" ${atuOnceki === '16' ? 'selected' : ''}>16</option>  
        </select></td>  
        <td><input type="number" class="isletme" readonly /></td>  
      `;  
      tbody.appendChild(row);  
    }  

    function hesapla() {  
      const rows = document.querySelectorAll("#noktalarTablo tr");  
      let toplamYukKaybi = 0;  
      const ilkKot = parseFloat(rows[0].querySelector(".kot").value) || 0;  
  
      rows.forEach((row, i) => {  
        const kot = parseFloat(row.querySelector(".kot").value) || 0;  
        const mesafe = parseFloat(row.querySelector(".mesafe").value) || 0;  
        const cap = row.querySelector(".boru").value;  
        const atu = row.querySelector(".atu").value;  
        const debi = parseFloat(row.querySelector(".debi").value) || 0;  
  
        const icCap = boruTablosu[cap][atu];  
        if (!icCap) {  
          alert(`İç çap bulunamadı: ${cap} - ${atu}`);  
          return;  
        }  
  
        const icCapM = icCap / 1000;  
        const alan = Math.PI * Math.pow(icCapM / 2, 2);  
        const hiz = debi / 1000 / alan;  
  
        const yukKaybi = 6.815 * Math.pow(hiz / 150, 1.852) * Math.pow(icCapM, -1.167) * mesafe;  
        toplamYukKaybi += yukKaybi;  
        const piezoKot = ilkKot - toplamYukKaybi;  
        const isletmeBasinci = piezoKot - kot;   
        row.querySelector(".isletme").value = isletmeBasinci.toFixed(2);  
      });  
    }

    function exceleKaydet() {
      const rows = document.querySelectorAll("#noktalarTablo tr");
      const ilkKot = parseFloat(rows[0]?.querySelector(".kot").value) || 0;
      let toplamYukKaybi = 0;
      const data = [["Debi (L/s)", "Kot (m)", "Mesafe (m)", "Yük Kaybı", "Toplam Yük Kaybı", "Boru Çapı", "Atü", "Hız (m/s)", "İşletme Basıncı", "Aparat"]];
      
      rows.forEach((row, i) => {
        const debi = parseFloat(row.querySelector(".debi").value) || 0;
        const kot = parseFloat(row.querySelector(".kot").value) || 0;
        const mesafe = parseFloat(row.querySelector(".mesafe").value) || 0;
        const cap = row.querySelector(".boru").value;
        const atu = row.querySelector(".atu").value;
        const icCap = boruTablosu[cap][atu] / 1000;
        const alan = Math.PI * Math.pow(icCap / 2, 2);
        const hiz = debi / 1000 / alan;
        const yukKaybi = 6.815 * Math.pow(hiz / 150, 1.852) * Math.pow(icCap, -1.167) * mesafe;
        toplamYukKaybi += yukKaybi;
        const piezoKot = ilkKot - toplamYukKaybi;
        const isletme = piezoKot - kot;

        let aparat = "";
        if (i > 0) {
          const prevKot = parseFloat(rows[i - 1].querySelector(".kot").value) || 0;
          const nextKot = parseFloat(rows[i + 1]?.querySelector(".kot")?.value) || null;

          if (nextKot !== null) {
            const farkPrevNext = Math.abs(prevKot - nextKot);
            
            if (farkPrevNext > 0.5) {
              if (kot > prevKot && kot > nextKot) aparat = "Vantuz";
              if (kot < prevKot && kot < nextKot) aparat = "Tahliye";
            }
          }
        }

        data.push([
          debi, kot, mesafe,
          yukKaybi.toFixed(2),
          toplamYukKaybi.toFixed(2),
          cap, atu,
          hiz.toFixed(2),
          isletme.toFixed(2),
          aparat
        ]);
      });

      const ws = XLSX.utils.aoa_to_sheet(data);
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Piezometre Hesabı");
      XLSX.writeFile(wb, "piezometre_hesabi.xlsx");
    }
  </script>  
</body>  
</html>